<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Radio Record Player ver. 1.205</title>
		<link rel="stylesheet" href="style.css" />
		<script src="js/jquery-3.7.1.min.js"></script>
		<script src="js/jquery-ui.min.js"></script>
		<script src="js/jquery.animateSprite.min.js"></script>
		<script src="js/jquery.mousewheel.js"></script>
		<script src="js/stations.js"></script>
		<script src="js/soundmanager2.js"></script>
	</head>
	<body>
		<div class="radio">
			<div class="station" id="rr"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_rr.m3u"></a></div><div class="bitrate"><div id="l32"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
			<div class="station" id="teo"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_teo.m3u"></a></div><div class="bitrate"><div id="l32" class="disabled"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
			<div class="station" id="ps"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_ps.m3u"></a></div><div class="bitrate"><div id="l32" class="disabled"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
			<div class="station" id="gop"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_gop.m3u"></a></div><div class="bitrate"><div id="l32" class="disabled"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
			<div class="station" id="tm"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_tm.m3u"></a></div><div class="bitrate"><div id="l32" class="disabled"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
			<div class="station" id="dc"><div class="station-img"><div class="cover"></div></div><div class="station-name"></div><div class="play disabled"><div class="play-button"></div><div class="play-button-bg"></div></div><div class="station-text"><span class="station-track-artist"></span><span class="station-track-title"></span></div><div class="volume"><div class="volume-click"></div><div class="volume-rollover"></div></div><div class="listen-outside"><a href="medialinks/listen_dc.m3u"></a></div><div class="bitrate"><div id="l32" class="disabled"></div><div id="l128"></div></div><div class="pie-timer"><div class="pie-spinner"></div></div></div>
		</div>
		<div class="footer">
			<div class="watch">
				<span class="playing-time"></span>
			</div>
			<div class="link">
				<a href="https://www.radiorecord.ru" target="_blank">www.radiorecord.ru</a>
				<div class="link-bg-blur"></div>
			</div>
		</div>
		<div class="tooltip"></div>
		<div class="context-menu">
			<ul>
				<li>
					<a href="https://www.radiorecord.ru" target="_blank">Radio Record</a>
				</li>
				<li>
					<a href="https://piratestation.info" target="_blank">Pirate Station</a>
				</li>
				<li>
					<a href="http://trancemission.ru" target="_blank">Trancemission</a>
				</li>
				<li>
					<a href="http://teodorfest.ru" target="_blank">Teodorfest</a>
				</li>
				<li>
					<a href="http://www.radiorecord.ru/gopfm" target="_blank">ГОП FM</a>
				</li>
				<li class="menu-separator"></li>
				<li>
					<a href="https://rimfoer.github.io/Radio-Record-Player-ver.-1.205/" name="Radio Record Player ver. 1.205">Открыть в другом окне</a>
				</li>
				<li>
					<a href="https://rimfoer.github.io/Radio-Record-Player-ver.-1.104s/" name="Radio Record Player ver. 1.104s">Перейти на старую версию</a>
				</li>
			</ul>
		</div>
		<div class="context-menu">
			<ul>
				<li>
					<div class="copytext">Скопировать</div>
				</li>
				<li class="menu-separator"></li>
				<li>
					<div class="applemusic">Apple Music</div>
				</li>
				<li>
					<div class="deezer">Deezer</div>
				</li>
				<li>
					<div class="spotify">Spotify</div>
				</li>
				<li>
					<div class="youtubemusic">Youtube Music</div>
				</li>
				<li class="menu-separator"></li>
				<li>
					<div class="vk">ВКонтакте</div>
				</li>
				<li>
					<div class="yandexmusic">Яндекс.Музыка</div>
				</li>
			</ul>
		</div>
		<script>
			let aInterval, advInterval, ctInterval, currParser, currStation, mInterval, radio, url; // переменные-пустышки на момент инициализации
			let currTime = getCurVolPos = int_phs = OtherParser = smErrorCounter = 0; // парочка переменных по-мелочи
			let bitrate = localStorage.currBitrate || 'l128'; // парсим значение текущего битрейта из сторэджа
			let currSpeed = $('.bitrate').children('#'+bitrate).index(); // нужна для streamSpeed
			let playStatus = 'reading'; // на момент инициализации статус воспроизведения равен "подготовке"
			let rmBitrate = invertBitrateValue(bitrate); // инвертируем значение битрейта для неактивной кнопки битрейта
			let startCount = 5; // отдельная переменная количества станций (работает в паре с int_phs, необходима для ф-ции update_title_Adv_shot)
			let stationText = []; // запоминает текст текущего трека при нажатии на пкм
			let volume = localStorage.currVolume || 70; // парсим уровень громкости
			let win = window.opener !== null ? true : false; // определяет, какой тип окна сейчас открыт (вкладка или попап)

			$(function() {
				if(win) showMessage('closeTab'); // если открыто попап-окно, отображаем сообщение о закрытии вкладки
				currColorScheme(); // проверяем, поддерживает браузер темную тему или нет
				update_title_Adv(); // ну и запускаем обновление текущих треков вне таймаута
			});

			soundManager.setup({
				preferFlash: false, // никакого флеша
				onready: function() {
					checkLSItems(); // проверяем наличие "нужных" строк в сторэдже
					sessionStorage.playSource = ''; // при загрузке страницы плеер явно ничего не воспроизводит
					playStatus = 'stopped'; // при успешной инициализации плеера меняем значение на "остановлен"
					$('.station').children('.play').removeClass('disabled');
					$('.volume-click, .volume-rollover').animateSprite(animParamsVolume);
					$('.volume-click').animateSprite('play', `${Math.round(volume/10)}`);
					$('.bitrate').children('div').animateSprite(animParamsBitrate);
					$('.bitrate').children('#'+bitrate).animateSprite('play', 'animate').addClass('active');
					$('.bitrate').children('#'+rmBitrate).animateSprite('play', 'remove');
				},
				useHighPerformance: false
			});

			soundManager.onerror = function() {
				smErrorCounter++;
				if(smErrorCounter < 10) setTimeout(() => soundManager.reboot(), 3000);
			};

			$(document).on('click', '.play-button', function(e) {
				e.preventDefault();
				if($(this).hasClass('playing') && playStatus === 'playing') {
					$(this).stop();
				} else if($(this).closest('.station').hasClass('active') && playStatus === 'stopped') {
					$(this).startPlay(url);
				} else if($(this).hasClass('playing') && playStatus === 'ended') {
					$(this).stop();
					setTimeout($(this).startPlay(url), 1000);
				} else {
					if(soundManager.soundIDs.length > 0) $(this).stop();
					$('.station').children('.volume, .bitrate, .pie-timer').removeClass('active');
					$('.station').removeClass('active');
					/****************************************************************************/
					$(this).closest('.station').addClass('active');
					radio = $('.station.active').attr('id'),
					currParser = $('.station.active').index().setCurrParser(),
					currStation = $('.station.active').index();
					setPlayURL(radio);
					$('.station.active').startPlay(url);
					$('.station.active').children('.pie-timer').addClass('active');
					update_title_Main(currParser);
					if(startCount === 5) {
						startCount = 4;
						parseCount(OtherParser);
					}
				}				
			});

			$(document).on('mousemove mousedown', '.volume.active', function(e) {
				let xpos = e.offsetX === undefined ? e.pageX-$(this).offset().left : e.offsetX;
				let	VolXMouse = Number(Math.round(xpos/25*10)*10).limiter();
				if(e.buttons === 1) {
					$('.volume-click').animateSprite('frame', `${Math.round(VolXMouse/10)}`);
					volume = VolXMouse;
					soundManager.setVolume('record', VolXMouse);
					localStorage.currVolume = VolXMouse;
					if(soundManager.muted) soundManager.unmute();
				}
				$(this).children('.volume-rollover').animateSprite(getCurVolPos === 0 ? 'play' : 'frame', `${Math.round(VolXMouse/10)}`);
				setTimeout(() => getCurVolPos = Math.round(VolXMouse/10), 300);
				showMessage('volume', VolXMouse);
			}).on('mouseleave', '.volume.active', function() {
				$(this).children('.volume-rollover').animateSprite('play', 'r'+getCurVolPos);
				setTimeout(() => getCurVolPos = 0, 300);
				showMessage();
			});

			$(document).on('click', '.listen-outside a', function() {
				if($(this).closest('.station').hasClass('active') && playStatus === 'playing') {
					$('#'+radio).stop();
				}
				return this.href;
			});

			$(document).on('click', '.bitrate.active div', function() {
				$('.bitrate').children('#'+bitrate).animateSprite('play', 'remove').removeClass('active');
				if(this.id !== bitrate) {
					bitrate = this.id,
					currSpeed = $('.bitrate').children('#'+this.id).index(),
					url = StreamDomain + streamNames[currStation] + streamSpeed[currSpeed];
				} else if(radio !== 'rr' && currSpeed === 0) {
					bitrate = 'l128',
					currSpeed = 1,
					url = StreamDomain + streamNames[currStation] + streamSpeed[1];
				}
				rmBitrate = invertBitrateValue(bitrate);
				$('.bitrate').children('#'+rmBitrate).animateSprite('play', 'remove');
				$('.bitrate').children('#'+bitrate).addClass('active').animateSprite('play', 'animate');
				$('#'+radio).startPlay(url);
				localStorage.currBitrate = this.id;
			}).on('mouseenter', '.bitrate.active div', function() {
				if(this.id !== bitrate) {
					rmBitrate = this.id;
					$('.bitrate').children('#'+rmBitrate).animateSprite('play', 'animate');
				}
			}).on('mouseleave', '.bitrate.active', function() {
				$('.bitrate').children('#'+rmBitrate).animateSprite('play', 'remove');
			});

			$('.link a').on('click', function(e) {
				e.preventDefault();
				window.open(this.href, '_blank').focus();
			});

			$(document).on('dblclick', '.station-text', function() {
				stationText = [$(this).children('span:eq(0)').attr('title'), $(this).children('span:eq(1)').attr('title')];
				if(stationText[0] === '' || showTitles.includes(stationText[1])) {
					showMessage('nocopy');
				} else {
					navigator.clipboard.writeText(stationText[0] + ' - ' + stationText[1]);
					showMessage('copy');
				}
			}).on('mousedown', '.station-text', function(e) {
				e.preventDefault();
				if(e.buttons === 2) {
					$('.context-menu').removeClass('active');
					stationText = [$(this).children('span:eq(0)').attr('title'), $(this).children('span:eq(1)').attr('title')];
				}
			}).on('mouseenter', '.station-text span', function() {
				if(localStorage.copyTextTip === 'false') {
					$(this).css('pointer-events', 'none');
					showMessage('copytext');
					setTimeout(() => $(this).css('pointer-events', ''), 6000);
					localStorage.copyTextTip = 'true';
				}
			});

			$(document).on('click', function() {
				$('.context-menu').removeClass('active');
			}).on('oncontextmenu', function() {
				return false;
			}).on('contextmenu', function(e) {
				e.preventDefault();
				$('.context-menu').removeClass('active');
				let currMenu = $(e.target).is('span.station-track-artist') || $(e.target).is('span.station-track-title') ? 1 : 0,
					h = parseInt($(`.context-menu:eq(${currMenu})`).css('height')),
					w = parseInt($(`.context-menu:eq(${currMenu})`).css('width')),
					l = e.pageX+w >= window.innerWidth/100*99 ? e.pageX-w-15 : e.pageX,
					t = e.pageY+h >= window.innerHeight/100*97 ? e.pageY-h-15 : e.pageY;
				$(`.context-menu:eq(${currMenu})`).css({left: `${l}px`, top: `${t}px`});
				$(`.context-menu:eq(${currMenu})`).addClass('active');
			}).on('mouseleave', function() {
				$('.context-menu').removeClass('active');
			});

			$('.context-menu:eq(0) ul li a').on('click', function(e) {
				e.preventDefault();
				$('.context-menu:eq(0)').removeClass('active');
				if(!$(this).attr('target')) {
					openURL(this.name, this.href);
				} else {
					window.open(this.href, '_blank').focus();
				}
			});

			$('.context-menu:eq(1) ul li div').on('click', function(e) {
				e.preventDefault();
				$('.context-menu:eq(1)').removeClass('active');
				switch($(this).attr('class')) {
					case 'copytext': {
						if(stationText[0] === '' || showTitles.includes(stationText[1])) {
							showMessage('nocopy');
						} else {
							navigator.clipboard.writeText(stationText[0] + ' - ' + stationText[1]);
							showMessage('copy');
						}
						break;
					}
					default: {
						window.open(String(audioStreamLink($(this).attr('class')) + encodeURI(stationText)), '_blank').focus();
						return false;
					}
				}
			});

			$('body').on('mousemove', function(e) {
				let ht = parseInt($('.tooltip').css('height')),
					wt = parseInt($('.tooltip').css('width')),
					lt = e.pageX+wt >= window.innerWidth/100*97 ? e.pageX-(wt-61) : e.pageX+18,
					tt = e.pageY+ht >= window.innerHeight/100*97 ? e.pageY-(ht-2) : e.pageY-2;
				$('.tooltip').css({left: `${lt}px`, top: `${tt}px`});
			});

			$(document).mousewheel(function(event, delta) {
				event.preventDefault();
				if(['playing','connecting'].includes(playStatus)) {
					if(delta>0) {
						volume = Math.round(volume-5).limiter();
					} else if(delta<0) {
						volume = Math.round(volume+5).limiter();
					}
					$('.volume-click').animateSprite('frame', Math.round(volume/10));
					soundManager.setVolume('record', volume);
					showMessage('volume');
					localStorage.currVolume = volume;
					if(soundManager.muted) soundManager.unmute();
				} else if(!$('.station').hasClass('active')) {
					showMessage('noselect');
				} else {
					showMessage('notplaying');
				}
			});

			$('body').on('keydown', function(e) {
				switch(e.which) {
					case 27: // esc
						$('.context-menu').removeClass('active');
						break;
					case 32: { // пробел
						radio !== undefined ? $('.station.active').play() : showMessage('noselect');
						break;
					}
					case (e.which>=49 && e.which<=54 ? e.which : false): { // 1, 2, 3, 4, 5, 6 (не numpad!)
						$(`${e.which.fastPlay()}`).play();
						break;
					}
					case (e.which>=97 && e.which<=102 ? e.which : false): { // 1, 2, 3, 4, 5, 6 (numpad)
						$(`${e.which.fastPlay()}`).play();
						break;
					}
					case 77: { // m
						if(soundManager.muted) {
							soundManager.unmute();
							$('.volume-click').animateSprite('frame', volume/10);
							showMessage('unmute');
						} else {
							soundManager.mute();
							$('.volume-click').animateSprite('frame', 0);
							showMessage('mute');
						}
						break;
					}
					case 82: { // r
						if(['playing','connecting'].includes(playStatus)) {
							$('.station.active').restart();
						} else if(!$('.station').hasClass('active')) {
							showMessage('noselect');
						} else {
							showMessage('notplaying');
						}
						break;
					}
				}
			});
		</script>
	</body>
</html>
